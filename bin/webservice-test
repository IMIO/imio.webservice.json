#!/bin/bash
# $1: number of generated elements (optional, default:1)
# $2: external_id counter (optional, default: random)
# $3: 'update' (optional, default: nothing)

AUTH="testuser:test"
DOMAIN="http://0.0.0.0:6543"
CLIENT="0109999"
# RANDOM produces a number between 0 - 32767
RD1=$(($RANDOM/4+1))
RD2=$(($RANDOM/4+1))
NB=$(($RD1*$RD2+30000000))
SIMUL=0
FILESIZE=`ls -al README.rst | awk '{print $5}'`
VERSION="1.1"
COUR_E="
{
    \"external_id\": \"IMIO$CLIENT\",
    \"type\": \"COUR_E\",
    \"pages_number\": 1,
    \"client_id\": \"$CLIENT\",
    \"scan_date\": \"2014-11-20\",
    \"scan_hour\": \"15:00:00\",
    \"user\": \"testuser\",
    \"pc\": \"pc-scan01\",
    \"creator\": \"scanner\",
    \"filesize\": $FILESIZE,
    \"filename\": \"README.rst\",
    \"filemd5\": \"1a23faa2ebc30b62784e93850e628781\"
}
"

if [ "$2" != "" ]
then
    NB=$2
fi
if [ "$3" == "update" ]
then
    COUR_E=${COUR_E/\}/,    \"update\": true\}}
fi
# sending metadata
for i in `seq 1 $1`;
do
    echo "Push element $i"
    NBi=`printf "%08d" $NB`
    COUR_Ei=${COUR_E/IMIO$CLIENT/$CLIENT$NBi}
    ((NB++))
    if [ "$SIMUL" -eq "1" ];
    then
        echo "curl -u $AUTH -X POST -H \"Content-Type: application/json\" -d \"$COUR_Ei\" $DOMAIN/dms_metadata/$CLIENT/$VERSION"
    else
        RET=`curl -u $AUTH -X POST -H "Content-Type: application/json" -d "$COUR_Ei" $DOMAIN/dms_metadata/$CLIENT/$VERSION`
        echo $RET
        ID=`expr "$RET" : '.*"id": \([0-9]*\)'`
    fi
    if [ "$SIMUL" -eq "1" ];
    then
        ID=1
        echo "curl -u $AUTH -i -F filedata=@README.rst $DOMAIN/file_upload/$VERSION/$ID"
    elif [ "$ID" != "" ]
    then
        RET=`curl -u $AUTH -i -F filedata=@README.rst $DOMAIN/file_upload/$VERSION/$ID`
        echo $RET
    fi
done
